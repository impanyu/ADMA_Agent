from google_auth_oauthlib.flow import Flow
from django.shortcuts import redirect
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build

import os

# SCOPES should include the required permissions for your app.
SCOPES = ['https://www.googleapis.com/auth/drive']

def google_drive_auth(request):
    # Create the flow using the client_secrets.json file.
    flow = Flow.from_client_secrets_file(
        'client_secret.json',
        scopes=SCOPES,
        redirect_uri='https://adma.hopto.org/google_drive_auth_callback'
    )

    # Get the authorization URL.
    auth_url, _ = flow.authorization_url(prompt='consent')

    # Redirect the user to the Google OAuth2 authorization page.
    return redirect(auth_url)



def google_drive_list(credential_file):
    # Load the credentials from the session.
    credentials = Credentials.from_authorized_user_file(credential_file,SCOPES)

    # Create a service object using the credentials.
    service = build('drive', 'v3', credentials=credentials)

    # Call the Drive v3 API.
    results = service.files().list(pageSize=100, fields="nextPageToken, files(id, name,size,webViewLink,modifiedTime, createdTime, mimeType)").execute()
    items = results.get('files', [])

    return items